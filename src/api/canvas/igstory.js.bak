/**
 * /api/canvas/igstory
 * Membuat gambar mirip Instagram Story dengan background hitam dan teks custom di tengah.
 */

const { createCanvas, loadImage, registerFont } = require("canvas");
const path = require("path");

module.exports = function (app, prefix = "") {
  app.get(`${prefix}/canvas/igstory`, async (req, res) => {
    const {
      username = "b4mzciIIIIIII",
      text = "Hallo Sayuki ðŸ’«",
      avatar = "https://i.ibb.co/0mYBq4R/avatar.png"
    } = req.query;

    try {
      const width = 720;
      const height = 1280;
      const canvas = createCanvas(width, height);
      const ctx = canvas.getContext("2d");

      // ðŸ–¤ Background full hitam
      ctx.fillStyle = "#000000";
      ctx.fillRect(0, 0, width, height);

      // âœï¸ Font
      registerFont(path.join(__dirname, "../../assets/font/Poppins-SemiBold.ttf"), { family: "Poppins" });

      // ðŸ§ Foto profil di atas kiri
      const pfp = await loadImage(avatar);
      const avatarSize = 80;
      const avatarX = 50;
      const avatarY = 60;
      ctx.save();
      ctx.beginPath();
      ctx.arc(avatarX + avatarSize / 2, avatarY + avatarSize / 2, avatarSize / 2, 0, Math.PI * 2);
      ctx.closePath();
      ctx.clip();
      ctx.drawImage(pfp, avatarX, avatarY, avatarSize, avatarSize);
      ctx.restore();

      // ðŸ‘¤ Username di sebelah kanan foto profil
      ctx.fillStyle = "#ffffff";
      ctx.font = "30px Poppins";
      ctx.textAlign = "left";
      ctx.fillText(username, avatarX + avatarSize + 30, avatarY + avatarSize / 1.5);

      // ðŸ“ Text di tengah (custom)
      ctx.font = "bold 50px Poppins";
      ctx.textAlign = "center";
      ctx.fillStyle = "#ffffff";
      const lines = wrapText(ctx, text, width - 200);
      lines.forEach((line, i) => {
        ctx.fillText(line, width / 2, height / 2 + i * 60);
      });

      // ðŸ”Š Icon volume kanan bawah
      ctx.font = "40px Poppins";
      ctx.fillText("ðŸ”Š", width - 60, height - 50);

      // âœ… Output
      res.setHeader("Content-Type", "image/png");
      res.send(canvas.toBuffer("image/png"));

    } catch (err) {
      res.status(500).json({ status: false, message: err.message });
    }
  });
};

// ðŸ§  Fungsi untuk membungkus teks panjang otomatis
function wrapText(ctx, text, maxWidth) {
  const words = text.split(" ");
  const lines = [];
  let currentLine = words[0];

  for (let i = 1; i < words.length; i++) {
    const word = words[i];
    const width = ctx.measureText(currentLine + " " + word).width;
    if (width < maxWidth) {
      currentLine += " " + word;
    } else {
      lines.push(currentLine);
      currentLine = word;
    }
  }
  lines.push(currentLine);
  return lines;
}
